'use strict';

$(function () {
    var main = document.querySelector('.main');
    // console.log(main.offsetWidth)
    var worldMap = void 0;
    var mouse = { x: 0, y: 0 };

    function Map() {
        this.width = main.offsetWidth;
        this.height = main.offsetHeight;

        this.viewAngle = 45;
        this.near = 0.1;
        this.far = 10000;
        this.cameraX = 0;
        this.cameraY = 350;
        this.cameraZ = 500;
        this.cameraLX = 0;
        this.cameraLY = 0;
        this.cameraLZ = 0;

        this.geo;
        this.scene = {};
        this.renderer = {};
        this.camera = {};
        this.controls = {};

        this.intersected = null;
    }

    Map.prototype = {

        init_d3: function init_d3() {
            var geoConfig = function geoConfig() {
                this.projection = d3.geoMercator().scale(120).translate([450, 0]);
                this.path = d3.geoPath().projection(this.projection);
            };

            this.geo = new geoConfig();
        },

        init_three: function init_three() {
            //*========================== support if
            if (Detector.webgl) {
                this.renderer = new THREE.WebGLRenderer({
                    antialias: true
                });
                this.renderer.setClearColor(0x888888);
            } else {
                this.renderer = new THREE.CanvasRenderer();
            }

            //support if ==========================*

            main.appendChild(this.renderer.domElement);
            this.renderer.setSize(this.width, this.height);

            this.scene = new THREE.Scene();

            this.camera = new THREE.PerspectiveCamera(this.viewAngle, this.width / this.height, this.near, this.far);
            this.camera.position.x = this.cameraX;
            this.camera.position.y = this.cameraY;
            this.camera.position.z = this.cameraZ;
            this.camera.lookAt({ x: this.cameraLX, y: 0, z: this.cameraLZ });

            // this.controls = new THREE.TrackballControls(this.camera);
            // this.controls.rotateSpeed = 1.0;
            // this.controls.zoomSpeed = 1.2;
            // this.controls.panSpeed = 0.8;
            // this.controls.noZoom = false;
            // this.controls.noPan = false;
            // this.controls.staticMoving = true;
            // this.controls.dynamicDampingFactor = 0.3;
        },

        addCountry: function addCountry(data) {
            var countries = [];

            for (var i in data.features) {
                var geoFeature = data.features[i];
                var properties = geoFeature.properties;
                var feature = this.geo.path(geoFeature);

                var mesh = transformSVGPathExposed(feature);
                for (var j in mesh) {
                    countries.push({ 'data': properties, 'mesh': mesh[j] });
                }
            }

            for (var _i in countries) {
                var shape3d = new THREE.ExtrudeGeometry(countries[_i].mesh, {
                    amount: 1,
                    bevelEnabled: false
                });

                var material = new THREE.MeshPhongMaterial({
                    color: this.getColor(countries[_i].data),
                    opacity: 0.5,
                    transparent: true
                });

                var toAdd = new THREE.Mesh(shape3d, material);
                toAdd.name = countries[_i].data.name;

                toAdd.rotation.x = Math.PI / 2;
                toAdd.translateX(-490);
                toAdd.translateY(50);
                toAdd.translateX(20);

                this.scene.add(toAdd);
            }
        },

        getColor: function getColor(data) {
            switch (data.name) {
                case 'United Kingdom':
                    return 0x46a3ff;
                case 'Canada':
                    return 0xff3b3b;
                case 'Thailand':
                    return 0x0dff0d;
                default:
                    return 0xd8d8d8;
            }

            // let multiplier = 0;
            //
            // for (let i = 0; i < 3; i++) {
            //     multiplier += data.iso_a3.charCodeAt(i);
            // }
            //
            // multiplier = (1.0 / 366) * multiplier;
            // return multiplier * 0xffffff
        },

        addLight: function addLight(x, y, z, intensity, color) {
            var pointLight = new THREE.PointLight(color);
            pointLight.position.x = x;
            pointLight.position.y = y;
            pointLight.position.z = z;
            pointLight.intensity = intensity;
            this.scene.add(pointLight);
        },

        addPlane: function addPlane(x, y, z, color) {
            var planeGeo = new THREE.CubeGeometry(x, y, z);
            var planeMat = new THREE.MeshLambertMaterial({ color: color });
            var plane = new THREE.Mesh(planeGeo, planeMat);

            // plane.rotation.y = -Math.PI / 2;
            this.scene.add(plane);
        },

        setCameraPosition: function setCameraPosition(x, y, z, lx, lz) {
            this.cameraX = x;
            this.cameraY = y;
            this.cameraZ = z;
            this.cameraLX = lx;
            this.cameraLZ = lz;
        },

        moveCamera: function moveCamera() {
            var speed = 0.2;
            var targetX = (this.cameraX = this.camera.position.x) * speed;
            var targetY = (this.cameraY = this.camera.position.y) * speed;
            var targetZ = (this.cameraZ = this.camera.position.z) * speed;

            this.camera.position.x += targetX;
            this.camera.position.y += targetY;
            this.camera.position.z += targetZ;
            this.camera.lookAt({ x: this.cameraLX, y: 0, z: this.cameraLZ });
        },

        animate: function animate() {
            if (this.cameraX !== this.camera.position.x || this.cameraY !== this.camera.position.y || this.cameraZ !== this.camera.position.z) {
                this.moveCamera();
            }
            var vector = new THREE.Vector3(mouse.x, mouse.y, 1);
            var raycaster = new THREE.Raycaster();
            raycaster.setFromCamera(vector, this.camera);
            var intersects = raycaster.intersectObjects(this.scene.children);

            var objects = this.scene.children;
            if (intersects.length >= 1) {
                if (this.intersected != intersects[0].object) {
                    if (this.intersected) {
                        for (var i = 0; i < objects.length; i++) {
                            if (objects[i].name === this.intersected.name) {
                                objects[i].material.opacity = 0.5;
                                objects[i].scale.z = 1;
                            }
                        }
                        this.intersected = null;
                    }
                }
                this.intersected = intersects[0].object;
                for (var _i2 = 0; _i2 < objects.length; _i2++) {
                    if (objects[_i2].name == this.intersected.name) {
                        objects[_i2].material.opacity = 1.0;
                        objects[_i2].scale.z = 5;
                    }
                }
            } else if (this.intersected) {
                for (var _i3 = 0; _i3 < objects.length; _i3++) {
                    if (objects[_i3].name == this.intersected.name) {
                        objects[_i3].material.opacity = 0.5;
                        objects[_i3].scale.z = 1;
                    }
                }
                this.intersected = null;
            }
            this.render();
        },

        render: function render() {
            // this.controls = new THREE.OrbitControls(this.camera, this.renderer.domElement);
            this.renderer.render(this.scene, this.camera);
        }

    };

    function init() {
        $.when($.getJSON('data/countries.json')).then(function (data) {
            console.log(data);
            worldMap = new Map();
            worldMap.init_d3();
            worldMap.init_three();
            // worldMap.addPlane(1400, 700, 30, 0xEEEEEE);
            worldMap.addCountry(data);
            worldMap.addLight(0, 3000, 0, 1.0, 0xFFFFFF);

            var onFrame = window.requestAnimationFrame;

            function tick(timestamp) {
                worldMap.animate();

                if (worldMap.intersected) {
                    $('#country-name').html(worldMap.intersected.name);
                } else {
                    $('#country-name').html("move mouse over map");
                }

                onFrame(tick);
            }

            onFrame(tick);
            main.addEventListener('mousemove', mouseMove, false);
        });
    }

    function mouseMove(e) {
        e.preventDefault();
        mouse.x = (e.clientX - main.offsetLeft) / main.offsetWidth * 2 - 1;
        mouse.y = -((e.clientY - main.offsetTop) / main.offsetHeight) * 2 + 1;
    }

    window.onunload = init();
});
//# sourceMappingURL=data:application/json;charset=utf8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbImFsbC5qcyJdLCJuYW1lcyI6WyIkIiwibWFpbiIsImRvY3VtZW50IiwicXVlcnlTZWxlY3RvciIsIndvcmxkTWFwIiwibW91c2UiLCJ4IiwieSIsIk1hcCIsIndpZHRoIiwib2Zmc2V0V2lkdGgiLCJoZWlnaHQiLCJvZmZzZXRIZWlnaHQiLCJ2aWV3QW5nbGUiLCJuZWFyIiwiZmFyIiwiY2FtZXJhWCIsImNhbWVyYVkiLCJjYW1lcmFaIiwiY2FtZXJhTFgiLCJjYW1lcmFMWSIsImNhbWVyYUxaIiwiZ2VvIiwic2NlbmUiLCJyZW5kZXJlciIsImNhbWVyYSIsImNvbnRyb2xzIiwiaW50ZXJzZWN0ZWQiLCJwcm90b3R5cGUiLCJpbml0X2QzIiwiZ2VvQ29uZmlnIiwicHJvamVjdGlvbiIsImQzIiwiZ2VvTWVyY2F0b3IiLCJzY2FsZSIsInRyYW5zbGF0ZSIsInBhdGgiLCJnZW9QYXRoIiwiaW5pdF90aHJlZSIsIkRldGVjdG9yIiwid2ViZ2wiLCJUSFJFRSIsIldlYkdMUmVuZGVyZXIiLCJhbnRpYWxpYXMiLCJzZXRDbGVhckNvbG9yIiwiQ2FudmFzUmVuZGVyZXIiLCJhcHBlbmRDaGlsZCIsImRvbUVsZW1lbnQiLCJzZXRTaXplIiwiU2NlbmUiLCJQZXJzcGVjdGl2ZUNhbWVyYSIsInBvc2l0aW9uIiwieiIsImxvb2tBdCIsImFkZENvdW50cnkiLCJkYXRhIiwiY291bnRyaWVzIiwiaSIsImZlYXR1cmVzIiwiZ2VvRmVhdHVyZSIsInByb3BlcnRpZXMiLCJmZWF0dXJlIiwibWVzaCIsInRyYW5zZm9ybVNWR1BhdGhFeHBvc2VkIiwiaiIsInB1c2giLCJzaGFwZTNkIiwiRXh0cnVkZUdlb21ldHJ5IiwiYW1vdW50IiwiYmV2ZWxFbmFibGVkIiwibWF0ZXJpYWwiLCJNZXNoUGhvbmdNYXRlcmlhbCIsImNvbG9yIiwiZ2V0Q29sb3IiLCJvcGFjaXR5IiwidHJhbnNwYXJlbnQiLCJ0b0FkZCIsIk1lc2giLCJuYW1lIiwicm90YXRpb24iLCJNYXRoIiwiUEkiLCJ0cmFuc2xhdGVYIiwidHJhbnNsYXRlWSIsImFkZCIsImFkZExpZ2h0IiwiaW50ZW5zaXR5IiwicG9pbnRMaWdodCIsIlBvaW50TGlnaHQiLCJhZGRQbGFuZSIsInBsYW5lR2VvIiwiQ3ViZUdlb21ldHJ5IiwicGxhbmVNYXQiLCJNZXNoTGFtYmVydE1hdGVyaWFsIiwicGxhbmUiLCJzZXRDYW1lcmFQb3NpdGlvbiIsImx4IiwibHoiLCJtb3ZlQ2FtZXJhIiwic3BlZWQiLCJ0YXJnZXRYIiwidGFyZ2V0WSIsInRhcmdldFoiLCJhbmltYXRlIiwidmVjdG9yIiwiVmVjdG9yMyIsInJheWNhc3RlciIsIlJheWNhc3RlciIsInNldEZyb21DYW1lcmEiLCJpbnRlcnNlY3RzIiwiaW50ZXJzZWN0T2JqZWN0cyIsImNoaWxkcmVuIiwib2JqZWN0cyIsImxlbmd0aCIsIm9iamVjdCIsInJlbmRlciIsImluaXQiLCJ3aGVuIiwiZ2V0SlNPTiIsInRoZW4iLCJjb25zb2xlIiwibG9nIiwib25GcmFtZSIsIndpbmRvdyIsInJlcXVlc3RBbmltYXRpb25GcmFtZSIsInRpY2siLCJ0aW1lc3RhbXAiLCJodG1sIiwiYWRkRXZlbnRMaXN0ZW5lciIsIm1vdXNlTW92ZSIsImUiLCJwcmV2ZW50RGVmYXVsdCIsImNsaWVudFgiLCJvZmZzZXRMZWZ0IiwiY2xpZW50WSIsIm9mZnNldFRvcCIsIm9udW5sb2FkIl0sIm1hcHBpbmdzIjoiOztBQUFBQSxFQUFFLFlBQVc7QUFDVCxRQUFNQyxPQUFPQyxTQUFTQyxhQUFULENBQXVCLE9BQXZCLENBQWI7QUFDQTtBQUNBLFFBQUlDLGlCQUFKO0FBQ0EsUUFBSUMsUUFBUSxFQUFDQyxHQUFHLENBQUosRUFBT0MsR0FBRyxDQUFWLEVBQVo7O0FBRUEsYUFBU0MsR0FBVCxHQUFlO0FBQ1gsYUFBS0MsS0FBTCxHQUFhUixLQUFLUyxXQUFsQjtBQUNBLGFBQUtDLE1BQUwsR0FBY1YsS0FBS1csWUFBbkI7O0FBRUEsYUFBS0MsU0FBTCxHQUFpQixFQUFqQjtBQUNBLGFBQUtDLElBQUwsR0FB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QUFPYSxRQUFQLEdBQWtCcEIsTUFBbEI7QUFDSCxDQXhRRCIsImZpbGUiOiJhbGwuanMiLCJzb3VyY2VzQ29udGVudCI6WyIkKGZ1bmN0aW9uKCkge1xyXG4gICAgY29uc3QgbWFpbiA9IGRvY3VtZW50LnF1ZXJ5U2VsZWN0b3IoJy5tYWluJyk7XHJcbiAgICAvLyBjb25zb2xlLmxvZyhtYWluLm9mZnNldFdpZHRoKVxyXG4gICAgbGV0IHdvcmxkTWFwO1xyXG4gICAgbGV0IG1vdXNlID0ge3g6IDAsIHk6IDB9O1xyXG5cclxuICAgIGZ1bmN0aW9uIE1hcCgpIHtcclxuICAgICAgICB0aGlzLndpZHRoID0gbWFpbi5vZmZzZXRXaWR0aDtcclxuICAgICAgICB0aGlzLmhlaWdodCA9IG1haW4ub2Zmc2V0SGVpZ2h0O1xyXG5cclxuICAgICAgICB0aGlzLnZpZXdBbmdsZSA9IDQ1O1xyXG4gICAgICAgIHRoaXMubmVhciA9IDAuMTtcclxuICAgICAgICB0aGlzLmZhciA9IDEwMDAwO1xyXG4gICAgICAgIHRoaXMuY2FtZXJhWCA9IDA7XHJcbiAgICAgICAgdGhpcy5jYW1lcmFZID0gMzUwO1xyXG4gICAgICAgIHRoaXMuY2FtZXJhWiA9IDUwMDtcclxuICAgICAgICB0aGlzLmNhbWVyYUxYID0gMDtcclxuICAgICAgICB0aGlzLmNhbWVyYUxZID0gMDtcclxuICAgICAgICB0aGlzLmNhbWVyYUxaID0gMDtcclxuXHJcbiAgICAgICAgdGhpcy5nZW87XHJcbiAgICAgICAgdGhpcy5zY2VuZSA9IHt9O1xyXG4gICAgICAgIHRoaXMucmVuZGVyZXIgPSB7fTtcclxuICAgICAgICB0aGlzLmNhbWVyYSA9IHt9O1xyXG4gICAgICAgIHRoaXMuY29udHJvbHMgPSB7fTtcclxuXHJcbiAgICAgICAgdGhpcy5pbnRlcnNlY3RlZCA9IG51bGw7XHJcbiAgICB9XHJcblxyXG4gICAgTWFwLnByb3RvdHlwZSA9IHtcclxuXHJcbiAgICAgICAgaW5pdF9kMzogZnVuY3Rpb24oKSB7XHJcbiAgICAgICAgICAgIGxldCBnZW9Db25maWcgPSBmdW5jdGlvbigpIHtcclxuICAgICAgICAgICAgICAgIHRoaXMucHJvamVjdGlvbiA9IGQzLmdlb01lcmNhdG9yKCkuc2NhbGUoMTIwKS50cmFuc2xhdGUoWzQ1MCwgMF0pO1xyXG4gICAgICAgICAgICAgICAgdGhpcy5wYXRoID0gZDMuZ2VvUGF0aCgpLnByb2plY3Rpb24odGhpcy5wcm9qZWN0aW9uKTtcclxuICAgICAgICAgICAgfTtcclxuXHJcbiAgICAgICAgICAgIHRoaXMuZ2VvID0gbmV3IGdlb0NvbmZpZygpO1xyXG4gICAgICAgIH0sXHJcblxyXG4gICAgICAgIGluaXRfdGhyZWU6IGZ1bmN0aW9uKCkge1xyXG4gICAgICAgICAgICAvLyo9PT09PT09PT09PT09PT09PT09PT09PT09PSBzdXBwb3J0IGlmXHJcbiAgICAgICAgICAgIGlmIChEZXRlY3Rvci53ZWJnbCkge1xyXG4gICAgICAgICAgICAgICAgdGhpcy5yZW5kZXJlciA9IG5ldyBUSFJFRS5XZWJHTFJlbmRlcmVyKHtcclxuICAgICAgICAgICAgICAgICAgICBhbnRpYWxpYXM6IHRydWVcclxuICAgICAgICAgICAgICAgIH0pO1xyXG4gICAgICAgICAgICAgICAgdGhpcy5yZW5kZXJlci5zZXRDbGVhckNvbG9yKDB4ODg4ODg4KTtcclxuICAgICAgICAgICAgfSBlbHNlIHtcclxuICAgICAgICAgICAgICAgIHRoaXMucmVuZGVyZXIgPSBuZXcgVEhSRUUuQ2FudmFzUmVuZGVyZXIoKTtcclxuICAgICAgICAgICAgfVxyXG5cclxuICAgICAgICAgICAgLy9zdXBwb3J0IGlmID09PT09PT09PT09PT09PT09PT09PT09PT09KlxyXG5cclxuICAgICAgICAgICAgbWFpbi5hcHBlbmRDaGlsZCh0aGlzLnJlbmRlcmVyLmRvbUVsZW1lbnQpO1xyXG4gICAgICAgICAgICB0aGlzLnJlbmRlcmVyLnNldFNpemUodGhpcy53aWR0aCwgdGhpcy5oZWlnaHQpO1xyXG5cclxuICAgICAgICAgICAgdGhpcy5zY2VuZSA9IG5ldyBUSFJFRS5TY2VuZSgpO1xyXG5cclxuICAgICAgICAgICAgdGhpcy5jYW1lcmEgPSBuZXcgVEhSRUUuUGVyc3BlY3RpdmVDYW1lcmEodGhpcy52aWV3QW5nbGUsIHRoaXMud2lkdGggLyB0aGlzLmhlaWdodCwgdGhpcy5uZWFyLCB0aGlzLmZhcik7XHJcbiAgICAgICAgICAgIHRoaXMuY2FtZXJhLnBvc2l0aW9uLnggPSB0aGlzLmNhbWVyYVg7XHJcbiAgICAgICAgICAgIHRoaXMuY2FtZXJhLnBvc2l0aW9uLnkgPSB0aGlzLmNhbWVyYVk7XHJcbiAgICAgICAgICAgIHRoaXMuY2FtZXJhLnBvc2l0aW9uLnogPSB0aGlzLmNhbWVyYVo7XHJcbiAgICAgICAgICAgIHRoaXMuY2FtZXJhLmxvb2tBdCh7IHg6IHRoaXMuY2FtZXJhTFgsIHk6IDAsIHo6IHRoaXMuY2FtZXJhTFogfSk7XHJcblxyXG4gICAgICAgICAgICAvLyB0aGlzLmNvbnRyb2xzID0gbmV3IFRIUkVFLlRyYWNrYmFsbENvbnRyb2xzKHRoaXMuY2FtZXJhKTtcclxuICAgICAgICAgICAgLy8gdGhpcy5jb250cm9scy5yb3RhdGVTcGVlZCA9IDEuMDtcclxuICAgICAgICAgICAgLy8gdGhpcy5jb250cm9scy56b29tU3BlZWQgPSAxLjI7XHJcbiAgICAgICAgICAgIC8vIHRoaXMuY29udHJvbHMucGFuU3BlZWQgPSAwLjg7XHJcbiAgICAgICAgICAgIC8vIHRoaXMuY29udHJvbHMubm9ab29tID0gZmFsc2U7XHJcbiAgICAgICAgICAgIC8vIHRoaXMuY29udHJvbHMubm9QYW4gPSBmYWxzZTtcclxuICAgICAgICAgICAgLy8gdGhpcy5jb250cm9scy5zdGF0aWNNb3ZpbmcgPSB0cnVlO1xyXG4gICAgICAgICAgICAvLyB0aGlzLmNvbnRyb2xzLmR5bmFtaWNEYW1waW5nRmFjdG9yID0gMC4zO1xyXG5cclxuICAgICAgICB9LFxyXG5cclxuICAgICAgICBhZGRDb3VudHJ5OiBmdW5jdGlvbihkYXRhKSB7XHJcbiAgICAgICAgICAgIGxldCBjb3VudHJpZXMgPSBbXTtcclxuXHJcbiAgICAgICAgICAgIGZvciAobGV0IGkgaW4gZGF0YS5mZWF0dXJlcykge1xyXG4gICAgICAgICAgICAgICAgbGV0IGdlb0ZlYXR1cmUgPSBkYXRhLmZlYXR1cmVzW2ldO1xyXG4gICAgICAgICAgICAgICAgbGV0IHByb3BlcnRpZXMgPSBnZW9GZWF0dXJlLnByb3BlcnRpZXM7XHJcbiAgICAgICAgICAgICAgICBsZXQgZmVhdHVyZSA9IHRoaXMuZ2VvLnBhdGgoZ2VvRmVhdHVyZSk7XHJcblxyXG4gICAgICAgICAgICAgICAgbGV0IG1lc2ggPSB0cmFuc2Zvcm1TVkdQYXRoRXhwb3NlZChmZWF0dXJlKTtcclxuICAgICAgICAgICAgICAgIGZvciAobGV0IGogaW4gbWVzaCkge1xyXG4gICAgICAgICAgICAgICAgICAgIGNvdW50cmllcy5wdXNoKHsgJ2RhdGEnOiBwcm9wZXJ0aWVzLCAnbWVzaCc6IG1lc2hbal0gfSlcclxuICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgfVxyXG5cclxuICAgICAgICAgICAgZm9yIChsZXQgaSBpbiBjb3VudHJpZXMpIHtcclxuICAgICAgICAgICAgICAgIGxldCBzaGFwZTNkID0gbmV3IFRIUkVFLkV4dHJ1ZGVHZW9tZXRyeShjb3VudHJpZXNbaV0ubWVzaCwge1xyXG4gICAgICAgICAgICAgICAgICAgIGFtb3VudDogMSxcclxuICAgICAgICAgICAgICAgICAgICBiZXZlbEVuYWJsZWQ6IGZhbHNlXHJcbiAgICAgICAgICAgICAgICB9KTtcclxuXHJcbiAgICAgICAgICAgICAgICBsZXQgbWF0ZXJpYWwgPSBuZXcgVEhSRUUuTWVzaFBob25nTWF0ZXJpYWwoe1xyXG4gICAgICAgICAgICAgICAgICAgIGNvbG9yOiB0aGlzLmdldENvbG9yKGNvdW50cmllc1tpXS5kYXRhKSxcclxuICAgICAgICAgICAgICAgICAgICBvcGFjaXR5OiAwLjUsXHJcbiAgICAgICAgICAgICAgICAgICAgdHJhbnNwYXJlbnQ6IHRydWVcclxuICAgICAgICAgICAgICAgIH0pO1xyXG5cclxuICAgICAgICAgICAgICAgIGxldCB0b0FkZCA9IG5ldyBUSFJFRS5NZXNoKHNoYXBlM2QsIG1hdGVyaWFsKTtcclxuICAgICAgICAgICAgICAgIHRvQWRkLm5hbWUgPSBjb3VudHJpZXNbaV0uZGF0YS5uYW1lO1xyXG5cclxuICAgICAgICAgICAgICAgIHRvQWRkLnJvdGF0aW9uLnggPSBNYXRoLlBJIC8gMjtcclxuICAgICAgICAgICAgICAgIHRvQWRkLnRyYW5zbGF0ZVgoLTQ5MCk7XHJcbiAgICAgICAgICAgICAgICB0b0FkZC50cmFuc2xhdGVZKDUwKTtcclxuICAgICAgICAgICAgICAgIHRvQWRkLnRyYW5zbGF0ZVgoMjApO1xyXG5cclxuICAgICAgICAgICAgICAgIHRoaXMuc2NlbmUuYWRkKHRvQWRkKTtcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgIH0sXHJcblxyXG4gICAgICAgIGdldENvbG9yOiBmdW5jdGlvbihkYXRhKSB7XHJcbiAgICAgICAgICAgIHN3aXRjaCAoZGF0YS5uYW1lKSB7XHJcbiAgICAgICAgICAgICAgICBjYXNlICdVbml0ZWQgS2luZ2RvbSc6XHJcbiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIDB4NDZhM2ZmO1xyXG4gICAgICAgICAgICAgICAgY2FzZSAnQ2FuYWRhJzpcclxuICAgICAgICAgICAgICAgICAgICByZXR1cm4gMHhmZjNiM2I7XHJcbiAgICAgICAgICAgICAgICBjYXNlICdUaGFpbGFuZCc6XHJcbiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIDB4MGRmZjBkO1xyXG4gICAgICAgICAgICAgICAgZGVmYXVsdDpcclxuICAgICAgICAgICAgICAgICAgICByZXR1cm4gMHhkOGQ4ZDg7XHJcbiAgICAgICAgICAgIH1cclxuXHJcbiAgICAgICAgICAgIC8vIGxldCBtdWx0aXBsaWVyID0gMDtcclxuICAgICAgICAgICAgLy9cclxuICAgICAgICAgICAgLy8gZm9yIChsZXQgaSA9IDA7IGkgPCAzOyBpKyspIHtcclxuICAgICAgICAgICAgLy8gICAgIG11bHRpcGxpZXIgKz0gZGF0YS5pc29fYTMuY2hhckNvZGVBdChpKTtcclxuICAgICAgICAgICAgLy8gfVxyXG4gICAgICAgICAgICAvL1xyXG4gICAgICAgICAgICAvLyBtdWx0aXBsaWVyID0gKDEuMCAvIDM2NikgKiBtdWx0aXBsaWVyO1xyXG4gICAgICAgICAgICAvLyByZXR1cm4gbXVsdGlwbGllciAqIDB4ZmZmZmZmXHJcbiAgICAgICAgfSxcclxuXHJcbiAgICAgICAgYWRkTGlnaHQ6IGZ1bmN0aW9uKHgsIHksIHosIGludGVuc2l0eSwgY29sb3IpIHtcclxuICAgICAgICAgICAgbGV0IHBvaW50TGlnaHQgPSBuZXcgVEhSRUUuUG9pbnRMaWdodChjb2xvcik7XHJcbiAgICAgICAgICAgIHBvaW50TGlnaHQucG9zaXRpb24ueCA9IHg7XHJcbiAgICAgICAgICAgIHBvaW50TGlnaHQucG9zaXRpb24ueSA9IHk7XHJcbiAgICAgICAgICAgIHBvaW50TGlnaHQucG9zaXRpb24ueiA9IHo7XHJcbiAgICAgICAgICAgIHBvaW50TGlnaHQuaW50ZW5zaXR5ID0gaW50ZW5zaXR5O1xyXG4gICAgICAgICAgICB0aGlzLnNjZW5lLmFkZChwb2ludExpZ2h0KTtcclxuICAgICAgICB9LFxyXG5cclxuICAgICAgICBhZGRQbGFuZTogZnVuY3Rpb24oeCwgeSwgeiwgY29sb3IpIHtcclxuICAgICAgICAgICAgbGV0IHBsYW5lR2VvID0gbmV3IFRIUkVFLkN1YmVHZW9tZXRyeSh4LCB5LCB6KTtcclxuICAgICAgICAgICAgbGV0IHBsYW5lTWF0ID0gbmV3IFRIUkVFLk1lc2hMYW1iZXJ0TWF0ZXJpYWwoeyBjb2xvcjogY29sb3IgfSk7XHJcbiAgICAgICAgICAgIGxldCBwbGFuZSA9IG5ldyBUSFJFRS5NZXNoKHBsYW5lR2VvLCBwbGFuZU1hdCk7XHJcblxyXG4gICAgICAgICAgICAvLyBwbGFuZS5yb3RhdGlvbi55ID0gLU1hdGguUEkgLyAyO1xyXG4gICAgICAgICAgICB0aGlzLnNjZW5lLmFkZChwbGFuZSk7XHJcbiAgICAgICAgfSxcclxuXHJcbiAgICAgICAgc2V0Q2FtZXJhUG9zaXRpb246IGZ1bmN0aW9uKHgsIHksIHosIGx4LCBseikge1xyXG4gICAgICAgICAgICB0aGlzLmNhbWVyYVggPSB4O1xyXG4gICAgICAgICAgICB0aGlzLmNhbWVyYVkgPSB5O1xyXG4gICAgICAgICAgICB0aGlzLmNhbWVyYVogPSB6O1xyXG4gICAgICAgICAgICB0aGlzLmNhbWVyYUxYID0gbHg7XHJcbiAgICAgICAgICAgIHRoaXMuY2FtZXJhTFogPSBsejtcclxuICAgICAgICB9LFxyXG5cclxuICAgICAgICBtb3ZlQ2FtZXJhOiBmdW5jdGlvbigpIHtcclxuICAgICAgICAgICAgbGV0IHNwZWVkID0gMC4yO1xyXG4gICAgICAgICAgICBsZXQgdGFyZ2V0WCA9ICh0aGlzLmNhbWVyYVggPSB0aGlzLmNhbWVyYS5wb3NpdGlvbi54KSAqIHNwZWVkO1xyXG4gICAgICAgICAgICBsZXQgdGFyZ2V0WSA9ICh0aGlzLmNhbWVyYVkgPSB0aGlzLmNhbWVyYS5wb3NpdGlvbi55KSAqIHNwZWVkO1xyXG4gICAgICAgICAgICBsZXQgdGFyZ2V0WiA9ICh0aGlzLmNhbWVyYVogPSB0aGlzLmNhbWVyYS5wb3NpdGlvbi56KSAqIHNwZWVkO1xyXG5cclxuICAgICAgICAgICAgdGhpcy5jYW1lcmEucG9zaXRpb24ueCArPSB0YXJnZXRYO1xyXG4gICAgICAgICAgICB0aGlzLmNhbWVyYS5wb3NpdGlvbi55ICs9IHRhcmdldFk7XHJcbiAgICAgICAgICAgIHRoaXMuY2FtZXJhLnBvc2l0aW9uLnogKz0gdGFyZ2V0WjtcclxuICAgICAgICAgICAgdGhpcy5jYW1lcmEubG9va0F0KHsgeDogdGhpcy5jYW1lcmFMWCwgeTogMCwgejogdGhpcy5jYW1lcmFMWiB9KTtcclxuICAgICAgICB9LFxyXG5cclxuICAgICAgICBhbmltYXRlOiBmdW5jdGlvbigpIHtcclxuICAgICAgICAgICAgaWYgKHRoaXMuY2FtZXJhWCAhPT0gdGhpcy5jYW1lcmEucG9zaXRpb24ueCB8fFxyXG4gICAgICAgICAgICAgICAgdGhpcy5jYW1lcmFZICE9PSB0aGlzLmNhbWVyYS5wb3NpdGlvbi55IHx8XHJcbiAgICAgICAgICAgICAgICB0aGlzLmNhbWVyYVogIT09IHRoaXMuY2FtZXJhLnBvc2l0aW9uLnopIHtcclxuICAgICAgICAgICAgICAgIHRoaXMubW92ZUNhbWVyYSgpO1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIGxldCB2ZWN0b3IgPSBuZXcgVEhSRUUuVmVjdG9yMyhtb3VzZS54LCBtb3VzZS55LCAxKTtcclxuICAgICAgICAgICAgbGV0IHJheWNhc3RlciA9IG5ldyBUSFJFRS5SYXljYXN0ZXIoKTtcclxuICAgICAgICAgICAgcmF5Y2FzdGVyLnNldEZyb21DYW1lcmEodmVjdG9yLCB0aGlzLmNhbWVyYSk7XHJcbiAgICAgICAgICAgIGxldCBpbnRlcnNlY3RzID1yYXljYXN0ZXIuaW50ZXJzZWN0T2JqZWN0cyh0aGlzLnNjZW5lLmNoaWxkcmVuKTtcclxuXHJcbiAgICAgICAgICAgIGxldCBvYmplY3RzID0gdGhpcy5zY2VuZS5jaGlsZHJlbjtcclxuICAgICAgICAgICAgaWYgKGludGVyc2VjdHMubGVuZ3RoID49IDEpIHtcclxuICAgICAgICAgICAgICAgIGlmICh0aGlzLmludGVyc2VjdGVkICE9IGludGVyc2VjdHNbMF0ub2JqZWN0KSB7XHJcbiAgICAgICAgICAgICAgICAgICAgaWYgKHRoaXMuaW50ZXJzZWN0ZWQpIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgZm9yIChsZXQgaSA9IDA7IGkgPCBvYmplY3RzLmxlbmd0aDsgaSsrKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAob2JqZWN0c1tpXS5uYW1lID09PSB0aGlzLmludGVyc2VjdGVkLm5hbWUpIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBvYmplY3RzW2ldLm1hdGVyaWFsLm9wYWNpdHkgPSAwLjU7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgb2JqZWN0c1tpXS5zY2FsZS56ID0gMTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgICAgICAgICB0aGlzLmludGVyc2VjdGVkID0gbnVsbDtcclxuICAgICAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICB0aGlzLmludGVyc2VjdGVkID0gaW50ZXJzZWN0c1swXS5vYmplY3Q7XHJcbiAgICAgICAgICAgICAgICBmb3IgKGxldCBpID0gMDsgaSA8IG9iamVjdHMubGVuZ3RoOyBpKyspIHtcclxuICAgICAgICAgICAgICAgICAgICBpZiAob2JqZWN0c1tpXS5uYW1lID09IHRoaXMuaW50ZXJzZWN0ZWQubmFtZSkge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICBvYmplY3RzW2ldLm1hdGVyaWFsLm9wYWNpdHkgPSAxLjA7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIG9iamVjdHNbaV0uc2NhbGUueiA9IDU7XHJcbiAgICAgICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgfVxyXG5cclxuICAgICAgICAgICAgfSBlbHNlIGlmICh0aGlzLmludGVyc2VjdGVkKSB7XHJcbiAgICAgICAgICAgICAgICBmb3IgKGxldCBpID0gMDsgaSA8IG9iamVjdHMubGVuZ3RoOyBpKyspIHtcclxuICAgICAgICAgICAgICAgICAgICBpZiAob2JqZWN0c1tpXS5uYW1lID09IHRoaXMuaW50ZXJzZWN0ZWQubmFtZSkge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICBvYmplY3RzW2ldLm1hdGVyaWFsLm9wYWNpdHkgPSAwLjU7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIG9iamVjdHNbaV0uc2NhbGUueiA9IDE7XHJcbiAgICAgICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgdGhpcy5pbnRlcnNlY3RlZCA9IG51bGw7XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgdGhpcy5yZW5kZXIoKTtcclxuICAgICAgICB9LFxyXG5cclxuICAgICAgICByZW5kZXI6IGZ1bmN0aW9uKCkge1xyXG4gICAgICAgICAgICAvLyB0aGlzLmNvbnRyb2xzID0gbmV3IFRIUkVFLk9yYml0Q29udHJvbHModGhpcy5jYW1lcmEsIHRoaXMucmVuZGVyZXIuZG9tRWxlbWVudCk7XHJcbiAgICAgICAgICAgIHRoaXMucmVuZGVyZXIucmVuZGVyKHRoaXMuc2NlbmUsIHRoaXMuY2FtZXJhKTtcclxuICAgICAgICB9XHJcblxyXG5cclxuICAgIH07XHJcblxyXG4gICAgZnVuY3Rpb24gaW5pdCgpIHtcclxuICAgICAgICAkLndoZW4oJC5nZXRKU09OKCcuLi9hc3NldHMvY291bnRyaWVzLmpzb24nKSkudGhlbigoZGF0YSkgPT4ge1xyXG4gICAgICAgICAgICBjb25zb2xlLmxvZyhkYXRhKTtcclxuICAgICAgICAgICAgd29ybGRNYXAgPSBuZXcgTWFwKCk7XHJcbiAgICAgICAgICAgIHdvcmxkTWFwLmluaXRfZDMoKTtcclxuICAgICAgICAgICAgd29ybGRNYXAuaW5pdF90aHJlZSgpO1xyXG4gICAgICAgICAgICAvLyB3b3JsZE1hcC5hZGRQbGFuZSgxNDAwLCA3MDAsIDMwLCAweEVFRUVFRSk7XHJcbiAgICAgICAgICAgIHdvcmxkTWFwLmFkZENvdW50cnkoZGF0YSk7XHJcbiAgICAgICAgICAgIHdvcmxkTWFwLmFkZExpZ2h0KDAsIDMwMDAsIDAsIDEuMCwgMHhGRkZGRkYpO1xyXG5cclxuXHJcbiAgICAgICAgICAgIGxldCBvbkZyYW1lID0gd2luZG93LnJlcXVlc3RBbmltYXRpb25GcmFtZTtcclxuXHJcbiAgICAgICAgICAgIGZ1bmN0aW9uIHRpY2sodGltZXN0YW1wKSB7XHJcbiAgICAgICAgICAgICAgICB3b3JsZE1hcC5hbmltYXRlKCk7XHJcblxyXG4gICAgICAgICAgICAgICAgaWYgKHdvcmxkTWFwLmludGVyc2VjdGVkKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgJCgnI2NvdW50cnktbmFtZScpLmh0bWwod29ybGRNYXAuaW50ZXJzZWN0ZWQubmFtZSk7XHJcbiAgICAgICAgICAgICAgICB9IGVsc2Uge1xyXG4gICAgICAgICAgICAgICAgICAgICQoJyNjb3VudHJ5LW5hbWUnKS5odG1sKFwibW92ZSBtb3VzZSBvdmVyIG1hcFwiKTtcclxuICAgICAgICAgICAgICAgIH1cclxuXHJcbiAgICAgICAgICAgICAgICBvbkZyYW1lKHRpY2spO1xyXG4gICAgICAgICAgICB9XHJcblxyXG4gICAgICAgICAgICBvbkZyYW1lKHRpY2spO1xyXG4gICAgICAgICAgICBtYWluLmFkZEV2ZW50TGlzdGVuZXIoJ21vdXNlbW92ZScsIG1vdXNlTW92ZSwgZmFsc2UpO1xyXG4gICAgICAgIH0pO1xyXG5cclxuICAgIH1cclxuXHJcbiAgICBmdW5jdGlvbiBtb3VzZU1vdmUoZSkge1xyXG4gICAgICAgIGUucHJldmVudERlZmF1bHQoKTtcclxuICAgICAgIG1vdXNlLnggPSAoKGUuY2xpZW50WCAtIG1haW4ub2Zmc2V0TGVmdCApIC8gbWFpbi5vZmZzZXRXaWR0aCkgKiAyIC0gMTtcclxuICAgICAgIG1vdXNlLnkgPSAtICgoZS5jbGllbnRZIC0gbWFpbi5vZmZzZXRUb3AgKSAvIG1haW4ub2Zmc2V0SGVpZ2h0KSAqIDIgKyAxO1xyXG4gICAgfVxyXG5cclxuXHJcbiAgICB3aW5kb3cub251bmxvYWQgPSBpbml0KCk7XHJcbn0pOyJdfQ==
